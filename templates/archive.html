{% extends "base.html" %}
{% block title %}å­¦ç¿’å±¥æ­´ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–{% endblock %}

{% block content %}
    <h2>å­¦ç¿’å±¥æ­´ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h2>

    <div class="card" style="margin-bottom: 30px;">
        <h3>ğŸ“Š ç´¯ç©å­¦ç¿’æ™‚é–“åˆ†æ</h3>
        <div style="margin-bottom: 15px;">
            <button class="btn-primary" id="btn-show-month">æœˆåˆ¥ç´¯ç©è¡¨ç¤º</button>
            <button class="btn-primary" id="btn-show-year">å¹´åˆ¥ç´¯ç©è¡¨ç¤º</button>
        </div>
        <canvas id="timeAnalysisChart" style="max-height: 400px;"></canvas>
    </div>
    
    <p>éå»ã®å­¦ç¿’è¨˜éŒ²ã¨å®Œæˆä½œå“ã‚’å¹´åº¦åˆ¥ã«é–²è¦§ã§ãã¾ã™ã€‚å„è¨˜éŒ²ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

    {% if not sorted_years %}
        <p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% else %}
        {% for year in sorted_years %}
            <div class="archive-section card">
                <h3>ğŸ“… {{ year }} å¹´ã®è¨˜éŒ²</h3>
                {% for record in archive_data[year] %}
                    <div class="record-entry view-detail" data-id="{{ record.id }}" 
                         data-type="{{ record.type }}"
                         data-subtype="{{ record.subtype }}"
                         data-date="{{ record.date.strftime('%Y-%m-%d %H:%M') }}"
                         data-description="{{ record.description | default('', true) }}"
                         data-xp="{{ "{:,.0f}".format(record.xp_gained) }}"
                         data-evaluation="{{ record.evaluation | default('', true) }}"
                         data-duration="{{ record.duration_minutes | default(0) }}"
                         data-image-url="{% if record.image_path %}{{ url_for('static', filename=record.image_path.split('/', 1)[1]) }}{% endif %}">
                        
                        {% if record.image_path %}
                            <img src="{{ url_for('static', filename=record.image_path.split('/', 1)[1]) }}" alt="ä½œå“ç”»åƒ" loading="lazy">
                        {% endif %}
                        <div class="record-details">
                            <strong>[{{ record.type }}]</strong> {{ record.subtype }}
                            <small style="color: #666;">ï¼ˆ{{ record.date.strftime('%Y-%m-%d') }}ï¼‰</small>
                            <p style="margin: 5px 0 0 0;">{{ record.description | default('ãƒ¡ãƒ¢ãªã—', true) | truncate(50) }}</p>
                        </div>
                        <div class="record-xp">
                            +{{ "{:,.0f}".format(record.xp_gained) }} XP
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    {% endif %}

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-grid">
                <div class="modal-image-area">
                    <img id="modal-image" src="" alt="ä½œå“ç”»åƒ" style="width: 100%; height: auto;">
                    <div id="modal-no-image" style="text-align: center; padding: 50px; border: 1px dashed #ccc; display: none;">ç”»åƒã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
                <div class="modal-details-area">
                    <h3 id="modal-title"></h3>
                    <p><strong>æ—¥ä»˜:</strong> <span id="modal-date"></span></p>
                    <p><strong>ç¨®åˆ¥:</strong> <span id="modal-type"></span></p>
                    <p><strong>ç²å¾—XP:</strong> <span id="modal-xp"></span></p>
                    <hr>
                    <p><strong>å†…å®¹:</strong> <span id="modal-description"></span></p>
                    <div id="modal-acq-info" style="margin-top: 10px; display: none;">
                        <p><strong>è©•ä¾¡:</strong> <span id="modal-evaluation"></span></p>
                    </div>
                    <div id="modal-time-info" style="margin-top: 10px; display: none;">
                        <p><strong>æ™‚é–“:</strong> <span id="modal-duration"></span> åˆ†</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .view-detail {
            cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
            transition: background-color 0.1s;
        }
        .view-detail:hover {
            background-color: #f0f0f0;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            position: fixed; 
            z-index: 200; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8); /* åŠé€æ˜ã®é»’ã„èƒŒæ™¯ */
        }
        .modal-content {
            background-color: white;
            margin: 5% auto; /* ç”»é¢ä¸­å¤®ã«é…ç½® */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 1000px; /* æœ€å¤§å¹…ã‚’æŒ‡å®š */
            border-radius: 8px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
            margin-right: -5px;
        }
        .close-btn:hover, .close-btn:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* ç”»åƒã‚¨ãƒªã‚¢ã‚’åºƒãã€è©³ç´°ã‚¨ãƒªã‚¢ã‚’ç‹­ã */
            gap: 20px;
        }
        .modal-image-area {
            max-height: 80vh; /* ç”»é¢ã®é«˜ã•ã«å¿œã˜ã¦åˆ¶é™ */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .modal-image-area img {
            object-fit: contain;
            cursor: default; /* æ‹¡å¤§ç”»åƒã¯ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ */
        }
        @media (max-width: 800px) {
            .modal-grid {
                grid-template-columns: 1fr; /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯ç¸¦ä¸¦ã³ */
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <script>
        // --- æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
    const archiveModal = document.getElementById("detail-modal");
    const archiveCloseBtn = document.querySelector(".close-btn");
    const archiveRecords = document.querySelectorAll(".view-detail");

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        archiveCloseBtn.onclick = function() {
            archiveModal.style.display = "none";
        };

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¤–ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.onclick = function(event) {
            if (event.target == archiveModal) {
                archiveModal.style.display = "none";
            }
        };

        // å„è¨˜éŒ²ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        archiveRecords.forEach(record => {
            record.addEventListener('click', function() {
                const imageUrl = this.dataset.imageUrl;
                const type = this.dataset.type;

                // ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆ
                document.getElementById('modal-title').textContent = this.dataset.subtype;
                document.getElementById('modal-date').textContent = this.dataset.date;
                document.getElementById('modal-type').textContent = type;
                document.getElementById('modal-xp').textContent = `+${this.dataset.xp} XP`;
                document.getElementById('modal-description').textContent = this.dataset.description || 'ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰';

                // ç”»åƒã®ã‚»ãƒƒãƒˆ
                const modalImage = document.getElementById('modal-image');
                const noImage = document.getElementById('modal-no-image');
                if (imageUrl) {
                    modalImage.src = imageUrl;
                    modalImage.style.display = 'block';
                    noImage.style.display = 'none';
                } else {
                    modalImage.style.display = 'none';
                    noImage.style.display = 'block';
                }

                // ã‚¿ã‚¤ãƒ—ã”ã¨ã®æƒ…å ±è¡¨ç¤ºåˆ‡æ›¿
                document.getElementById('modal-acq-info').style.display = 'none';
                document.getElementById('modal-time-info').style.display = 'none';
                
                if (type === 'ç§‘ç›®ç¿’å¾—') {
                    document.getElementById('modal-acq-info').style.display = 'block';
                    document.getElementById('modal-evaluation').textContent = this.dataset.evaluation;
                } else if (type === 'æ™‚é–“å­¦ç¿’') {
                    document.getElementById('modal-time-info').style.display = 'block';
                    document.getElementById('modal-duration').textContent = this.dataset.duration;
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                archiveModal.style.display = "block";
            });
        });

        // --- å­¦ç¿’æ™‚é–“ã‚°ãƒ©ãƒ•å‡¦ç† ---
        const ctx = document.getElementById('timeAnalysisChart').getContext('2d');
        let timeChart = null; 
        
        // ----------------------------------------------------
        // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿è£œé–“é–¢æ•° (ç´¯ç©æ™‚é–“è¡¨ç¤ºç”¨)
        // ----------------------------------------------------
        // â€» ç´¯ç©å€¤ã¯åˆ†(minutes)ã§ä¿æŒã—ã€å¾Œã§ä¸€åº¦ã ã‘æ™‚é–“(hours)ã«å¤‰æ›ã—ã¾ã™ã€‚

        /**
         * æ¬ æã—ã¦ã„ã‚‹æœˆã‚’è£œé–“ã—ã€ç´¯ç©å­¦ç¿’æ™‚é–“ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
         * @param {Array<Object>} aggregatedData - {date: Date, total_time: number} ã®é…åˆ— (minutes)
         */
        function fillMissingMonths(aggregatedData) {
            if (aggregatedData.length === 0) return { labels: [], data: [] };

            // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹æœ€åˆã¨æœ€å¾Œã®æœˆã‚’å–å¾—
            const firstDate = aggregatedData[0].date;
            const lastDate = aggregatedData[aggregatedData.length - 1].date;

            const filledData = [];
            let cumulativeTime = 0;
            let currentDataIndex = 0;

            // æœ€åˆã®æœˆã®1æ—¥ã«è¨­å®š
            let currentDate = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
            
            // æœ€å¾Œã®æœˆã®æœ«æ—¥ã¾ã§ãƒ«ãƒ¼ãƒ—
            while (currentDate <= lastDate || 
                   currentDate.getFullYear() < lastDate.getFullYear() || 
                   (currentDate.getFullYear() === lastDate.getFullYear() && currentDate.getMonth() <= lastDate.getMonth())) {
                
                const currentMonthLabel = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                
                // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (currentDataIndex < aggregatedData.length) {
                    const recordDate = aggregatedData[currentDataIndex].date;
                    const recordMonthLabel = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (currentMonthLabel === recordMonthLabel) {
                        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ç´¯ç©æ™‚é–“ã«åŠ ç®—
                        cumulativeTime += aggregatedData[currentDataIndex].total_time;
                        currentDataIndex++;
                        // åŒã˜æœˆã«è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã€æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚‚åŒã˜æœˆã‹ãƒã‚§ãƒƒã‚¯
                        while (currentDataIndex < aggregatedData.length && 
                               `${aggregatedData[currentDataIndex].date.getFullYear()}-${String(aggregatedData[currentDataIndex].date.getMonth() + 1).padStart(2, '0')}` === currentMonthLabel) {
                            cumulativeTime += aggregatedData[currentDataIndex].total_time;
                            currentDataIndex++;
                        }
                    }
                }
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„æœˆã§ã‚‚ã€ç›´å‰ã®ç´¯ç©æ™‚é–“ã‚’ä¿æŒã—ãŸã¾ã¾è¨˜éŒ²
                filledData.push({
                    label: currentMonthLabel,
                    cumulative: cumulativeTime // ç´¯ç©å€¤ (minutes)
                });
                
                // æ¬¡ã®æœˆã«é€²ã‚€
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            return {
                labels: filledData.map(d => d.label),
                data: filledData.map(d => d.cumulative)
            };
        }

        /**
         * æ¬ æã—ã¦ã„ã‚‹å¹´ã‚’è£œé–“ã—ã€ç´¯ç©å­¦ç¿’æ™‚é–“ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
         * @param {Array<Object>} aggregatedData - {date: Date, total_time: number} ã®é…åˆ— (minutes)
         */
        function fillMissingYears(aggregatedData) {
            if (aggregatedData.length === 0) return { labels: [], data: [] };

            const firstYear = aggregatedData[0].date.getFullYear();
            const lastYear = aggregatedData[aggregatedData.length - 1].date.getFullYear();

            const filledData = [];
            let cumulativeTime = 0;
            let currentDataIndex = 0;

            for (let year = firstYear; year <= lastYear; year++) {
                let currentYearTime = 0;
                
                // ãã®å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦é›†è¨ˆ
                while (currentDataIndex < aggregatedData.length && aggregatedData[currentDataIndex].date.getFullYear() === year) {
                    currentYearTime += aggregatedData[currentDataIndex].total_time;
                    currentDataIndex++;
                }

                // ç´¯ç©æ™‚é–“ã«åŠ ç®—
                cumulativeTime += currentYearTime;

                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å¹´ã§ã‚‚ã€ç›´å‰ã®ç´¯ç©æ™‚é–“ã‚’ä¿æŒã—ãŸã¾ã¾è¨˜éŒ²
                filledData.push({
                    label: String(year),
                    cumulative: cumulativeTime // ç´¯ç©å€¤ (minutes)
                });
            }

            return {
                labels: filledData.map(d => d.label),
                data: filledData.map(d => d.cumulative)
            };
        }

        // ----------------------------------------------------
        // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
        // ----------------------------------------------------

        function renderChart(period) {
            // app.pyã§å®šç¾©ã—ãŸAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (åˆ†å˜ä½ã®é›†è¨ˆå€¤)
            fetch(`/api/time_analysis/${period}`)
                .then(response => response.json())
                .then(apiData => {
                    if (apiData.error) {
                        console.error(data.error);
                        return;
                    }

                    // APIã‹ã‚‰å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€æ—¥ä»˜ã¨æ™‚é–“ã«å¤‰æ›
                    const rawData = apiData.labels.map((label, index) => {
                        let date;
                        if (period === 'month') {
                            const [year, month] = label.split('-').map(Number);
                            date = new Date(year, month - 1, 1);
                        } else {
                            date = new Date(Number(label), 0, 1);
                        }

                        return {
                            date: date,
                            total_time: apiData.data[index] // minutes
                        };
                    }).sort((a, b) => a.date - b.date); // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ

                    
                    let processedData;
                    let chartTitle;
                    
                    if (period === 'month') {
                        processedData = fillMissingMonths(rawData);
                        chartTitle = "ç´¯ç©å­¦ç¿’æ™‚é–“ï¼ˆæœˆæ¬¡ï¼‰";
                    } else { // 'year'
                        processedData = fillMissingYears(rawData);
                        chartTitle = "ç´¯ç©å­¦ç¿’æ™‚é–“ï¼ˆå¹´æ¬¡ï¼‰";
                    }
                    
                    // ã€â˜…â˜…æœ€çµ‚ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ˜…â˜…ã€‘ãƒ‡ãƒ¼ã‚¿ã‚’æ™‚é–“ã«å¤‰æ› (åˆ† / 60)
                    // è¨ˆç®—ã¯ä¸€åº¦ã§å®Œäº†ã—ã€toFixed(2)ã‚’ä½¿ã‚ãšã€Math.roundã§ä¸¸ã‚è¾¼ã¿ã¾ã™ã€‚
                    // 5æ™‚é–“=300åˆ†ãŒ 5.00 ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
                    const finalDataInHours = processedData.data.map(minutes => {
                         // minutes / 60.0 ã§æ™‚é–“ï¼ˆhoursï¼‰ã‚’è¨ˆç®—ã—ã€å°æ•°ç‚¹ç¬¬2ä½ã§å››æ¨äº”å…¥ã—ã¦æ•°å€¤ã¨ã—ã¦è¿”ã™
                         return Math.round(minutes * 100) / 100;
                    });


                    // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°ç ´æ£„
                    if (timeChart) {
                        timeChart.destroy();
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°è¡¨ç¤ºã‚’ä¸­æ­¢
                    if (finalDataInHours.length === 0) {
                        const chartDiv = document.getElementById('timeAnalysisChart').parentNode;
                        chartDiv.innerHTML = '<p style="text-align: center; padding: 50px; color: #666;">ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                        return;
                    }
                    // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€Canvasã‚’å…ƒã«æˆ»ã™
                    const chartDiv = document.getElementById('timeAnalysisChart').parentNode;
                    if (chartDiv.querySelector('p')) {
                        chartDiv.innerHTML = '<canvas id="timeAnalysisChart" style="max-height: 400px;"></canvas>';
                        const newCtx = document.getElementById('timeAnalysisChart').getContext('2d');
                        ctx.canvas = newCtx.canvas;
                    }


                    // æ–°ã—ã„ã‚°ãƒ©ãƒ•ã®æç”»
                    timeChart = new Chart(ctx, {
                        type: 'bar', // æ£’ã‚°ãƒ©ãƒ•
                        data: {
                            labels: processedData.labels,
                            datasets: [{
                                label: chartTitle,
                                data: finalDataInHours,
                                backgroundColor: 'rgba(0, 119, 204, 0.8)', 
                                borderColor: 'rgba(0, 119, 204, 1)',
                                borderWidth: 1,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'ç´¯ç©å­¦ç¿’æ™‚é–“ (æ™‚é–“)' // å˜ä½ã¯æ™‚é–“
                                    },
                                    // ç›®ç››ã‚Šè¡¨ç¤ºã‚’èª¿æ•´ã—ã€å°æ•°ç‚¹ä»¥ä¸‹ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¼·åˆ¶
                                    ticks: {
                                        callback: function(value, index, ticks) {
                                            return value.toFixed(2) + ' æ™‚é–“';
                                        }
                                    }
                                },
                                x: {
                                    type: 'category'
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: chartTitle
                                },
                                tooltip: {
                                    callbacks: {
                                        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã«è¡¨ç¤ºã™ã‚‹å€¤ã‚’æ•´å½¢ï¼ˆæ™‚é–“å˜ä½ï¼‰
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§ã‚‚å°æ•°ç‚¹ç¬¬2ä½ã¾ã§è¡¨ç¤ºã‚’ä¿è¨¼
                                                label += context.parsed.y.toFixed(2) + ' æ™‚é–“'; 
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error));
        }

        // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.getElementById('btn-show-month').addEventListener('click', () => renderChart('month'));
        document.getElementById('btn-show-year').addEventListener('click', () => renderChart('year'));

        // åˆæœŸè¡¨ç¤ºï¼šæœˆåˆ¥
        renderChart('month'); 

    </script>
{% endblock %}