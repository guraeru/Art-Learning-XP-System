{% extends "base.html" %}
{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
    <h2>{{ status.username | default('ãƒ¦ãƒ¼ã‚¶ãƒ¼') }} ã®ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>

    <div class="card status-grid" style="margin-bottom: 30px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="status-item">
            <h4>ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</h4>
            <div class="xp-display">R{{ status.rank | default(1) }}</div>
            <div class="rank-title">{{ status.title | default('æœªç™»éŒ²') }}</div>
        </div>
        <div class="status-item">
            <h4>ç´¯è¨ˆXP</h4>
            <div class="xp-display">{{ "{:,.0f}".format(status.total_xp | default(0)) }} XP</div>
        </div>
        <div class="status-item">
            <h4>æ¬¡ãƒ©ãƒ³ã‚¯ (R{{ (status.rank | default(1)) + 1 }}) ã¾ã§</h4>
            <div class="xp-display">{{ "{:,.0f}".format(status.xp_to_next_rank | default(0)) }} XP</div>
                {% set total_needed = (status.next_xp_goal | default(1)) - (status.xp_start_of_current_level | default(0)) %}
                {% set current_progress = (status.total_xp | default(0)) - (status.xp_start_of_current_level | default(0)) %}
                {% set percent = (current_progress / total_needed) * 100 if total_needed > 0 else 100 %}
                <div style="background-color: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                <div style="--progress-width: {{ percent | round(1) }}%; background-color: var(--accent-color); height: 100%; width: var(--progress-width);">
                </div>
            </div>
            <div class="rank-title">ï¼ˆç›®æ¨™: {{ "{:,.0f}".format(status.next_xp_goal | default(0)) }} XPï¼‰</div>
        </div>
    <div class="status-item">
        <h4>ç´¯è¨ˆå­¦ç¿’æ™‚é–“</h4>
            <div class="xp-display">{{ status.total_time_hours | default(0) }} æ™‚é–“</div>
        <div class="rank-title">{{ (status.total_time_minutes | default(0)) % 60 }} åˆ†</div>
    </div>
    </div>
    <div class="tabs" style="margin-bottom: 20px;">
        <button class="tab-button btn-primary" data-tab="home">ãƒ›ãƒ¼ãƒ </button>
        <button class="tab-button" data-tab="works">ä½œå“ ({{ user_works | length | default(0) }})</button>
        <button class="tab-button" data-tab="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</button>
        <button class="tab-button" data-tab="analysis">ã‚¢ã‚¯ã‚»ã‚¹è§£æ</button>
    </div>

    <div id="home" class="tab-content card">
        
        <h3 style="margin-top: 10px;">ğŸ¨ pixiv ä»Šæ—¥ã®ãŠé¡Œãƒ»æ–°ç€ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ</h3>
    <div class="topics-grid grid-2" style="gap: 20px;">
            {% for topic in pixiv_topics %}
                <a href="{{ topic.url }}" target="_blank" class="topic-card card" style="text-decoration: none; color: inherit; padding: 15px; overflow: hidden; transition: box-shadow 0.3s;">
                    <h4 style="color: var(--accent-color); margin-top: 0;">{{ topic.title }}</h4>
                    {% if topic.image %}
                        <div class="pixiv-image-wrapper">
                       <img src="{{ url_for('static', filename=topic.image) }}" 
                           alt="{{ topic.title }}" 
                           class="topic-image"
                           style="border-radius: 4px;" loading="lazy"> </div>
                    {% else %}
                        <p style="font-size: 0.9em; color: #666;">pixivã§è©³ç´°ã‚’ç¢ºèª</p>
                    {% endif %}
                </a>
            {% endfor %}
        </div>

        <h3 style="margin-top: 30px;">ä½œå“ã‚’æŠ•ç¨¿ã—ã¦XPã‚’ç²å¾—</h3>
        <form action="{{ url_for('log_acquisition') }}" method="POST" enctype="multipart/form-data" style="margin-bottom: 20px; border: 1px dashed #ccc; padding: 20px; border-radius: 4px;">
            <h4>æ–°è¦ä½œå“æŠ•ç¨¿</h4>
            <div class="form-group">
                <label for="technique_type">ä½œå“ã‚¿ã‚¤ãƒˆãƒ«/æŠ€æ³•:</label>
                <input type="text" name="technique_type" id="mypage_title" class="form-control" placeholder="ä½œå“ã®ã‚¿ã‚¤ãƒˆãƒ«ã€ã¾ãŸã¯ç¿’å¾—ã—ãŸæŠ€æ³•" required>
            </div>
            
            <div class="form-group">
                <label for="mypage_evaluation">è‡ªå·±è©•ä¾¡ (XPå€ç‡ã«å½±éŸ¿):</label>
                <select name="evaluation" id="mypage_evaluation" class="form-control" required>
                    {% for eval_key, eval_score in evaluations.items()|sort(attribute='1', reverse=True) %}
                        <option value="{{ eval_key }}">{{ eval_key }} (ã‚¹ã‚³ã‚¢: {{ eval_score }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="image_proof">ä½œå“ç”»åƒ (PNG, JPG, GIF):</label>
                <input type="file" name="image_proof" id="mypage_image" class="form-control" required accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="mypage_description">ä½œå“ã®è©³ç´°:</label>
                <textarea name="description" id="mypage_description" class="form-control" rows="4" placeholder="ä½œå“ã®èª¬æ˜ã‚„ã€ã“ã®ä½œå“ã‚’é€šã˜ã¦å­¦ã‚“ã ã“ã¨ã€å·¥å¤«ã—ãŸç‚¹ãªã©ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"></textarea>
            </div>

            <button type="submit" class="btn-primary" style="width: 100%;">ä½œå“ã‚’æŠ•ç¨¿</button>
        </form>

    </div>

    <div id="works" class="tab-content card" style="display: none;">
        <h3>æŠ•ç¨¿ã—ãŸä½œå“ä¸€è¦§</h3>
        {% if not user_works %}
            <p>ã¾ã æŠ•ç¨¿ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ–°ã—ã„ä½œå“ã‚’æŠ•ç¨¿ã—ã¾ã—ã‚‡ã†ï¼</p>
        {% else %}
            <div class="works-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                {% for work in user_works %}
                    {% set file_name = work.image_path.split('/')[-1].split('\\')[-1] if work.image_path else '' %}

                    <div class="work-item card view-detail" 
                        style="padding: 10px; text-align: center; border: 1px solid #eee; cursor: pointer;"
                        data-id="{{ work.id }}"
                        data-type="{{ work.type }}"
                        data-subtype="{{ work.subtype }}"
                        data-date="{{ work.date.strftime('%Y-%m-%d %H:%M') }}"
                        data-description="{{ work.description | default('', true) }}" data-xp="{{ "{:,.0f}".format(work.xp_gained) }}"
                        data-evaluation="{{ work.evaluation | default('') }}"
                        data-image="{{ file_name }}"> 
                        {% if work.image_path %}
                       <img src="{{ url_for('uploaded_file', filename=file_name) }}" 
                           alt="{{ work.subtype }}" 
                           style="width: 100%; height: 150px; object-fit: cover; border-radius: 4px;" loading="lazy">
                        {% else %}
                             <div style="width: 100%; height: 150px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px;">ç”»åƒãªã—</div>
                        {% endif %}
                        <strong style="display: block; margin-top: 10px;">{{ work.subtype | truncate(20) }}</strong>
                        <small style="color: #666;">{{ work.date.strftime('%Y-%m-%d') }} | +{{ "{:,.0f}".format(work.xp_gained | default(0)) }} XP</small>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div id="reaction" class="tab-content card" style="display: none;">
        <h3>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
        <p style="color: #666;">â€» ã“ã®æ©Ÿèƒ½ã¯ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚</p>
    </div>
    
    <div id="analysis" class="tab-content card" style="display: none;">
        <h3>ã‚¢ã‚¯ã‚»ã‚¹è§£æãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <p style="color: #666;">â€» ã“ã®æ©Ÿèƒ½ã¯ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚</p>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.tab;

                    // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    tabs.forEach(t => {
                        t.classList.remove('btn-primary');
                        t.style.backgroundColor = '#ddd';
                        t.style.color = 'var(--text-color)';
                    });
                    tab.classList.add('btn-primary');
                    tab.style.backgroundColor = 'var(--accent-color)';
                    tab.style.color = 'white';


                    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤º
                    contents.forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(targetId).style.display = 'block';
                });
            });

            // åˆæœŸè¡¨ç¤º: Homeã‚¿ãƒ–
            const initialTab = document.querySelector('.tab-button[data-tab="home"]');
            if (initialTab) {
                initialTab.click();
            }
        });
    </script>
    <style>
        /* ğŸŒŸ Pixiv ç”»åƒã®è¡¨ç¤ºã‚’ä¿®æ­£ã™ã‚‹ CSS ğŸŒŸ */
        .pixiv-image-wrapper {
            height: 150px; /* ç”»åƒã®é«˜ã•ã‚’å›ºå®šï¼ˆå…ƒç”»åƒã®é«˜ã•ã‚’ç¶­æŒï¼‰ */
            width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            background-color: #f0f0f0; /* èƒŒæ™¯è‰²ã‚’è¨­å®šã—ã¦ã€åã‚ãŸéš›ã®ä½™ç™½ã‚’è¦‹ã‚„ã™ãã™ã‚‹ */
        }
        
        .pixiv-image-wrapper .topic-image {
            width: 100%;
            height: 100%;
            /* ğŸŒŸ ç”»åƒå…¨ä½“ãŒã‚³ãƒ³ãƒ†ãƒŠã«åã¾ã‚‹ã‚ˆã†ã«ç¸®å°ãƒ»è¡¨ç¤ºï¼ˆè¦‹åˆ‡ã‚Œé˜²æ­¢ï¼‰ */
            object-fit: contain; 
        }
        /* ------------------------------------------- */

        .tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .tab-button {
            background-color: #ddd;
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            white-space: nowrap;
        }
        .tab-button:not(.btn-primary):hover {
            background-color: #ccc;
        }
        /* GIF/é™æ­¢ç”»ã®åˆ‡ã‚Šæ›¿ã‚ã‚Šé¢¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (ãƒ›ãƒãƒ¼æ™‚) */
        .topic-card:hover .topic-image {
            opacity: 0.85; /* ã‚ãšã‹ã«æš—ãã™ã‚‹ */
            transform: scale(1.02); /* ã‚ãšã‹ã«æ‹¡å¤§ */
            transition: opacity 0.3s, transform 0.3s;
        }
        .topic-image {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
{% endblock %}