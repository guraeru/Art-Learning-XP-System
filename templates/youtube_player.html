<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ playlist.title }} - YouTube ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 10px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .player-section {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .player-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .player-header h1 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }
        
        .player-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .player-frame {
            width: 100%;
            height: 600px;
            background: black;
        }
        
        .player-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .progress-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .progress-card h3 {
            font-size: 1em;
            margin-bottom: 12px;
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }
        
        .video-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .video-list h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #333;
        }
        
        .video-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border-left: 3px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            user-select: none;
        }
        
        .video-item:hover {
            background-color: #efefef;
            border-left-color: #667eea;
            transform: translateX(2px);
        }
        
        .video-item.completed {
            border-left-color: #4CAF50;
            background-color: #f1f8f4;
        }
        
        .video-item.completed:before {
            content: "âœ“ ";
            color: #4CAF50;
            font-weight: bold;
        }
        
        .video-item.current {
            border-left-color: #764ba2;
            background-color: #f3f1fa;
            font-weight: bold;
            box-shadow: inset -3px 0px 0 #764ba2;
        }
        
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .player-frame {
                height: 400px;
            }
        }
        
        .xp-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="player-section">
            <div class="player-header">
                <h1>{{ playlist.title }}</h1>
                <p>YouTube ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†ç”Ÿ</p>
            </div>
            <div class="player-frame">
                <div id="youtube-player" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div style="background: white; padding: 15px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="skipToPreviousVideo()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em;">
                    â† æˆ»ã‚‹
                </button>
                <button onclick="skipToNextVideo()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em;">
                    â†’ æ¬¡ã¸
                </button>
                <button onclick="toggleAutoPlayback()" id="autoPlayButton" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em;">
                    â¯ è‡ªå‹•å†ç”Ÿ: ON
                </button>
                <button onclick="window.open('https://www.youtube.com/playlist?list=' + PLAYLIST_YOUTUBE_ID, 'youtube')" style="padding: 10px 20px; background: #FF6B6B; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em;">
                    ğŸ”— YouTubeã§é–‹ã
                </button>
            </div>
        </div>
        
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar">
            <!-- é€²æ—çŠ¶æ³ -->
            <div class="progress-card">
                <h3>é€²æ—çŠ¶æ³</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: {{ (completed_count / total_count * 100) if total_count > 0 else 0 }}%"></div>
                </div>
                <div class="progress-text">
                    <strong id="progress-text">{{ completed_count }} / {{ total_count }}</strong> å‹•ç”»å®Œäº†
                </div>
            </div>
            
            <!-- å‹•ç”»ãƒªã‚¹ãƒˆ -->
            <div class="video-list">
                <h3>ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h3>
                <div id="video-list-container" style="min-height: 200px;">
                    <p style="color: #999; font-size: 0.9em; text-align: center; padding: 20px 0;">
                        ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const PLAYLIST_ID = {{ playlist.id }};
        const PLAYLIST_YOUTUBE_ID = "{{ playlist.playlist_id }}";
        const ACTUAL_VIDEO_COUNT = {{ actual_video_count }};
        let currentVideoIndex = {{ current_index or 0 }};
        const videoProgress = {};
        let playerReady = false;
        
        // **æ–°æ©Ÿèƒ½**: è‡ªå‹•å†ç”Ÿãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ONï¼‰
        let autoPlaybackEnabled = true;
        console.log('[INIT] Auto-playback mode: ON');
        
        // **é‡è¦**: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‹•ç”»IDãƒªã‚¹ãƒˆã‚’å–å¾—
        const VIDEO_IDS = [
        {%- for video_id in video_ids %}
            "{{ video_id }}",
        {%- endfor %}
        ];
        console.log(`[INIT] Loaded ${VIDEO_IDS.length} video IDs from server`, VIDEO_IDS);
        
        // **é‡è¦**: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‹•ç”»æƒ…å ±ãƒãƒƒãƒ—ã‚’å–å¾—ï¼ˆéå…¬é–‹å‹•ç”»ã®æ¤œå‡ºç”¨ï¼‰
        const VIDEO_INFO_MAP = {
        {%- if video_info_map %}
            {%- for video_id, info in video_info_map.items() %}
            "{{ video_id }}": {
                title: {{ info.title|tojson }},
                privacy_status: {{ info.privacy_status|tojson }},
                embeddable: {{ info.embeddable|tojson }},
                thumbnail_url: {{ info.thumbnail_url|tojson if info.thumbnail_url else 'null' }}
            },
            {%- endfor %}
        {%- endif %}
        };
        console.log(`[INIT] Loaded video info for ${Object.keys(VIDEO_INFO_MAP).length} videos`, VIDEO_INFO_MAP);
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å®Œäº†æ¸ˆã¿å‹•ç”»æƒ…å ±ã‚’åˆæœŸåŒ–
        const completedVideos = [
        {%- for video in video_views %}
            {%- if video.is_completed %}
                {{ video.video_index }},
            {%- endif %}
        {%- endfor %}
        ];
        
        // ãƒ“ãƒ‡ã‚ªã”ã¨ã®XPæƒ…å ±ã‚’ä¿å­˜ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ï¼‰
        const videoXPMap = {
        {%- for video in video_views %}
            {%- if video.is_completed %}
                {{ video.video_index }}: {{ video.xp_gained }},
            {%- endif %}
        {%- endfor %}
        };
        
        // å®Œäº†æ¸ˆã¿å‹•ç”»ã‚’videoProgressã«è¨­å®š
        completedVideos.forEach(index => {
            videoProgress[index] = true;
        });
        
        console.log(`[INIT] PLAYLIST_ID=${PLAYLIST_ID}, ACTUAL_VIDEO_COUNT=${ACTUAL_VIDEO_COUNT}, COMPLETED=${completedVideos.length}`, videoXPMap);
        
        // **æ–°æ©Ÿèƒ½**: æœ€åˆã®æœªå®Œäº†å‹•ç”»ã‚’æ¤œç´¢ã—ã¦è¨­å®š
        function findFirstIncompleteVideo() {
            for (let i = 0; i < ACTUAL_VIDEO_COUNT; i++) {
                if (!videoProgress[i]) {
                    console.log(`[INIT] First incomplete video found at index ${i}`);
                    return i;
                }
            }
            // ã™ã¹ã¦å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯æœ€å¾Œã®å‹•ç”»ã‚’è¿”ã™
            console.log('[INIT] All videos completed, showing last video');
            return ACTUAL_VIDEO_COUNT - 1;
        }
        
        // åˆæœŸåŒ–æ™‚ã«æœ€åˆã®æœªå®Œäº†å‹•ç”»ã‚’è¨­å®š
        currentVideoIndex = findFirstIncompleteVideo();
        console.log(`[INIT] currentVideoIndex set to ${currentVideoIndex}`);
        
        // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®URLã‚’ç”Ÿæˆ
        const playlistUrl = `https://www.youtube.com/playlist?list=${PLAYLIST_YOUTUBE_ID}`;
        
        // å‹•ç”»IDãƒãƒƒãƒ—ã‚’ç”Ÿæˆï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â†’ YouTubeå‹•ç”»IDï¼‰
        const VIDEO_ID_MAP = {};
        VIDEO_IDS.forEach((id, idx) => {
            VIDEO_ID_MAP[idx] = id;
        });
        console.log(`[INIT] VIDEO_ID_MAP created with ${Object.keys(VIDEO_ID_MAP).length} entries`);
        
        // YouTube IFrame API ã‚’èª­ã¿è¾¼ã‚€
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        tag.async = true;
        tag.onerror = () => console.error('[ERROR] Failed to load YouTube IFrame API');
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        let player;
        const videoStates = {}; // å„ãƒ“ãƒ‡ã‚ªã®å†ç”Ÿæ™‚é–“ã‚’è¨˜éŒ²
        
        // YouTube IFrame API åˆæœŸåŒ–ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function onYouTubeIframeAPIReady() {
            console.log('[YOUTUBE API] API ready - initializing first player');
            playerReady = true;
            initializePlayer();
        }
        
        // Player ã‚’åˆæœŸåŒ–ï¼ˆæœ€åˆã®èª­ã¿è¾¼ã¿æ™‚ã®ã¿ï¼‰
        function initializePlayer() {
            if (player) {
                console.log('[PLAYER] Player already initialized, skipping');
                return;
            }
            
            console.log('[PLAYER] Creating new player instance');
            const startVideoId = VIDEO_ID_MAP[currentVideoIndex];
            
            player = new YT.Player('youtube-player', {
                height: '600',
                width: '100%',
                videoId: startVideoId,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
            
            console.log('[PLAYER] Player instance created with videoId:', startVideoId);
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æº–å‚™å®Œäº†
        function onPlayerReady(event) {
            console.log('[PLAYER] Player ready');
            playerReady = true;
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å†ç”ŸçŠ¶æ…‹ç›£è¦–ã‚’é–‹å§‹
            startPlaybackMonitoring();
        }
        
        // å†ç”ŸçŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã¨ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function onPlayerStateChange(event) {
            console.log('[PLAYER] State changed:', event.data);
            console.log('[PLAYER] Player object:', player ? 'exists' : 'NOT FOUND');
            console.log('[PLAYER] Current video index:', currentVideoIndex);
            
            const YT_PLAYING = 1;
            const YT_PAUSED = 2;
            const YT_ENDED = 0;
            
            if (event.data === YT_PLAYING) {
                console.log('[PLAYBACK] â–¶ Playing video');
                // å†ç”Ÿä¸­: watch ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
                recordPlaybackTime();
            } else if (event.data === YT_PAUSED) {
                console.log('[PLAYBACK] â¸ Video paused');
            } else if (event.data === YT_ENDED) {
                console.log('[PLAYBACK] â¹ Video ENDED - calling handleVideoEnded()');
                console.log('[PLAYBACK] Auto-playback flag:', autoPlaybackEnabled);
                
                // å‹•ç”»çµ‚äº†: å®Œäº†ã‚’ãƒãƒ¼ã‚¯
                handleVideoEnded();
            }
        }
        
        // å‹•ç”»çµ‚äº†æ™‚ã®å‡¦ç†
        function handleVideoEnded() {
            console.log(`[AUTO] Video ${currentVideoIndex} ended`);
            console.log(`[AUTO] Auto-playback enabled: ${autoPlaybackEnabled}`);
            
            console.log(`[AUTO] Auto-completing video ${currentVideoIndex}...`);
            
            // ç¾åœ¨ã®å‹•ç”»ã‚’å®Œäº†ã¨ã—ã¦è¨˜éŒ²
            const videoDuration = player && player.getDuration ? Math.floor(player.getDuration()) : 3600;
            
            // APIã«å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
            fetch('/api/video_view_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    playlist_id: PLAYLIST_ID,
                    video_index: currentVideoIndex,
                    event_type: 'complete',
                    current_time: videoDuration
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(`[AUTO] Video ${currentVideoIndex} marked as completed`);
                if (data.status === 'success') {
                    // UI ã‚’æ›´æ–°
                    markVideoAsCompleted(currentVideoIndex);
                    updateProgressBar();
                }
                
                // è‡ªå‹•å†ç”ŸãŒæœ‰åŠ¹ãªå ´åˆã®ã¿æ¬¡ã®å‹•ç”»ã‚’å†ç”Ÿ
                if (autoPlaybackEnabled) {
                    const nextIndex = currentVideoIndex + 1;
                    if (nextIndex < ACTUAL_VIDEO_COUNT) {
                        console.log(`[AUTO] Playing next video: ${nextIndex}`);
                        setTimeout(() => {
                            switchToVideo(nextIndex);
                        }, 2000); // 2ç§’å¾Œã«æ¬¡ã®å‹•ç”»ã‚’å†ç”Ÿ
                    } else {
                        console.log(`[AUTO] All videos completed!`);
                        alert('ğŸ‰ ã™ã¹ã¦ã®å‹•ç”»ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    }
                } else {
                    console.log(`[AUTO] Auto-playback is disabled, waiting for manual next`);
                }
            })
            .catch(error => {
                console.error('[ERROR] Failed to mark video as completed:', error);
            });
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function onPlayerError(event) {
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: 2=invalid param, 5=HTML5 player error, 100=video not found, 101=video owner doesn't allow embedding, 150=same as 101
            const errorCodes = {
                2: 'Invalid parameter',
                5: 'HTML5 player error',
                100: 'Video not found',
                101: 'Video owner doesn\'t allow embedding',
                150: 'Video owner doesn\'t allow embedding'
            };
            
            const errorMsg = errorCodes[event.data] || `Unknown error (${event.data})`;
            console.error('[PLAYER ERROR]', errorMsg);
            
            // YouTube Ads ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            if (event.data === 2 || event.data === 5) {
                console.log('[PLAYER] Minor error (ads or network related), continuing...');
            }
        }
        
        // å†ç”ŸçŠ¶æ…‹ã‚’å®šæœŸçš„ã«ç›£è¦–
        function startPlaybackMonitoring() {
            setInterval(() => {
                if (!player || !player.getPlayerState) return;
                
                const state = player.getPlayerState();
                const YT_PLAYING = 1;
                
                // å†ç”Ÿä¸­ã®å ´åˆã€å®šæœŸçš„ã«å†ç”Ÿæ™‚é–“ã‚’è¨˜éŒ²
                if (state === YT_PLAYING) {
                    recordPlaybackTime();
                }
            }, 5000); // 5ç§’ã”ã¨
        }
        
        // å†ç”Ÿæ™‚é–“ã‚’è¨˜éŒ²
        function recordPlaybackTime() {
            if (!player || !player.getCurrentTime) return;
            
            const currentTime = Math.floor(player.getCurrentTime());
            const duration = player.getDuration ? Math.floor(player.getDuration()) : 0;
            
            if (duration > 0) {
                console.log(`[WATCH] ${currentTime}s / ${duration}s (${Math.round(currentTime / duration * 100)}%)`);
                sendVideoEvent('watch', currentTime);
            }
        }
        
        // æ¬¡ã®å‹•ç”»ã«ã‚¹ã‚­ãƒƒãƒ—
        // æ¬¡ã®å‹•ç”»ã«ã‚¹ã‚­ãƒƒãƒ—
        function skipToNextVideo() {
            const nextIndex = currentVideoIndex + 1;
            if (nextIndex < ACTUAL_VIDEO_COUNT) {
                console.log(`[ACTION] Skipping to video ${nextIndex}`);
                switchToVideo(nextIndex);
            } else {
                alert('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æœ€å¾Œã«é”ã—ã¾ã—ãŸ');
            }
        }
        
        // å‰ã®å‹•ç”»ã«æˆ»ã™
        function skipToPreviousVideo() {
            const prevIndex = currentVideoIndex - 1;
            if (prevIndex >= 0) {
                console.log(`[ACTION] Going back to video ${prevIndex}`);
                switchToVideo(prevIndex);
            } else {
                alert('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æœ€åˆã§ã™');
            }
        }
        
        // **æ–°æ©Ÿèƒ½**: è‡ªå‹•å†ç”Ÿã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleAutoPlayback() {
            autoPlaybackEnabled = !autoPlaybackEnabled;
            const button = document.getElementById('autoPlayButton');
            const statusText = autoPlaybackEnabled ? 'ON' : 'OFF';
            const statusColor = autoPlaybackEnabled ? '#FF9800' : '#757575';
            
            button.textContent = `â¯ è‡ªå‹•å†ç”Ÿ: ${statusText}`;
            button.style.background = statusColor;
            
            console.log(`[ACTION] Auto-playback toggled: ${statusText}`);
            console.log(`[DEBUG] autoPlaybackEnabled = ${autoPlaybackEnabled}`);
        }
        
        // å‹•ç”»ãƒªã‚¹ãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ç”»ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchToVideo(videoIndex) {
            console.log(`[ACTION] ========== switchToVideo called with videoIndex=${videoIndex} ==========`);
            
            currentVideoIndex = videoIndex;
            updateCurrentVideoUI();
            
            // å‹•ç”»IDãƒãƒƒãƒ—ã‹ã‚‰å¯¾å¿œã™ã‚‹ YouTube å‹•ç”»IDã‚’å–å¾—
            const youtubeVideoId = VIDEO_ID_MAP[videoIndex];
            
            if (!youtubeVideoId) {
                console.error(`[ERROR] No video ID found for index ${videoIndex}`);
                alert(`å‹•ç”» ${videoIndex + 1} ã®å‹•ç”»IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }
            
            console.log(`[ACTION] Switching to video ${videoIndex}: ${youtubeVideoId}`);
            
            // YT.Player ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
            if (player && player.loadVideoById) {
                console.log(`[PLAYER] Using loadVideoById to auto-play new video`);
                // loadVideoById ã¯å‹•ç”»ã‚’è‡ªå‹•å†ç”Ÿã™ã‚‹ï¼ˆloadVideoByIdã¯cueVideoByIdã‚ˆã‚Šç¢ºå®Ÿã«å†ç”Ÿã•ã‚Œã‚‹ï¼‰
                player.loadVideoById(youtubeVideoId);
                console.log(`[PLAYER] New video loaded and auto-playing`);
            } else {
                console.warn(`[WARN] Player not ready, waiting for API...`);
                // APIãŒã¾ã æº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯å¾Œã§è©¦ã™
                setTimeout(() => {
                    if (player && player.loadVideoById) {
                        console.log(`[PLAYER] Retrying loadVideoById after delay`);
                        player.loadVideoById(youtubeVideoId);
                    }
                }, 500);
            }
            
            sendVideoEvent('start');
        }
        
        
        // å‹•ç”»å†ç”Ÿã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
        async function sendVideoEvent(eventType, currentTime = 0) {
            try {
                const response = await fetch('/api/video_view_event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        playlist_id: PLAYLIST_ID,
                        video_index: currentVideoIndex,
                        event_type: eventType,
                        current_time: currentTime
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    console.log(`[API] Event ${eventType} recorded for video ${currentVideoIndex}`);
                    
                    if (eventType === 'complete') {
                        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« XP æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°
                        markVideoAsCompleted(currentVideoIndex);
                        
                        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã® XP ã‚’å–å¾—
                        const xpData = data.xp_gained || null;
                        if (xpData) {
                            console.log(`[XP] Gained ${xpData} XP`);
                            updateProgressBar();  // é€²æ—ãƒãƒ¼ã‚’å†æ›´æ–°
                        }
                    }
                }
            } catch (error) {
                console.error('Error sending video event:', error);
            }
        }
        
        // å‹•ç”»ã‚’å®Œäº†æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
        function markVideoAsCompleted(videoIndex) {
            videoProgress[videoIndex] = true;
            updateProgressBar();
            updateVideoItemUI(videoIndex);
        }
        
        // å‹•ç”»ãƒªã‚¹ãƒˆã‚’å‹•çš„ã«ç”Ÿæˆ
        async function loadPlaylistVideos() {
            try {
                const container = document.getElementById('video-list-container');
                
                console.log(`[LOADING] Creating video list with ${ACTUAL_VIDEO_COUNT} videos`);
                
                const videoCount = ACTUAL_VIDEO_COUNT;
                let html = '';
                
                for (let i = 0; i < videoCount; i++) {
                    const isCompleted = videoProgress[i] ? 'completed' : '';
                    const isCurrent = i === currentVideoIndex ? 'current' : '';
                    
                    // å‹•ç”»IDã‚’å–å¾—
                    const videoId = VIDEO_ID_MAP[i];
                    
                    // å‹•ç”»æƒ…å ±ã‹ã‚‰å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
                    const videoInfo = VIDEO_INFO_MAP[videoId];
                    const videoTitle = videoInfo && videoInfo.title ? videoInfo.title : `å‹•ç”» ${i + 1}`;
                    
                    // ã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ã™ãã‚‹å ´åˆã¯çœç•¥
                    const displayTitle = videoTitle.length > 45 ? videoTitle.substring(0, 45) + '...' : videoTitle;
                    
                    html += `
                        <div class="video-item ${isCompleted} ${isCurrent}" data-video-index="${i}">
                            <div>
                                <strong style="font-size: 0.95em; line-height: 1.4;">
                                    <span style="color: #667eea; font-weight: bold;">${i + 1}.</span> ${displayTitle}
                                </strong>
                                ${videoProgress[i] ? `<span class="xp-badge">+${videoXPMap[i] || 100} XP</span>` : ''}
                            </div>
                            <div style="font-size: 0.75em; color: #999; margin-top: 3px;">
                                ${videoProgress[i] ? 'å®Œäº†' : 'æœªè¦–è´'}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                console.log(`[SUCCESS] Loaded ${videoCount} videos`);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸDOMè¦ç´ ã«ã‚¢ã‚¿ãƒƒãƒ
                const items = document.querySelectorAll('.video-item');
                console.log(`[DEBUG] Found ${items.length} video items to attach listeners`);
                
                items.forEach((item, idx) => {
                    const videoIndex = parseInt(item.dataset.videoIndex);
                    console.log(`[DEBUG] Item ${idx}: dataset.videoIndex=${item.dataset.videoIndex}, parsed=${videoIndex}`);
                    
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const clickedIndex = parseInt(item.dataset.videoIndex);
                        console.log(`[CLICK] Video item #${idx} clicked: videoIndex=${clickedIndex}, currentVideoIndex was ${currentVideoIndex}`);
                        switchToVideo(clickedIndex);
                    });
                });
                
                console.log(`[LISTENERS] Attached click listeners to ${items.length} items`);
                updateProgressBar();
            } catch (error) {
                console.error('Error loading playlist videos:', error);
                document.getElementById('video-list-container').innerHTML = 
                    '<p style="color: red; font-size: 0.9em;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }
        
        // UI ã‚’æ›´æ–°ï¼ˆé€²æ—ãƒãƒ¼ï¼‰
        function updateProgressBar() {
            const completedCount = Object.keys(videoProgress).length;
            const totalCount = ACTUAL_VIDEO_COUNT;
            const progressPercent = totalCount > 0 ? (completedCount / totalCount * 100).toFixed(1) : 0;
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = completedCount + ' / ' + totalCount;
        }
        
        // ç¾åœ¨ã®å‹•ç”»ã‚’ UI ã§å¼·èª¿è¡¨ç¤º
        function updateCurrentVideoUI() {
            document.querySelectorAll('.video-item').forEach((item) => {
                const index = parseInt(item.dataset.videoIndex);
                item.classList.toggle('current', index === currentVideoIndex);
            });
        }
        
        // ç‰¹å®šã®å‹•ç”»ã‚¢ã‚¤ãƒ†ãƒ ã® UI ã‚’æ›´æ–°
        function updateVideoItemUI(videoIndex) {
            const item = document.querySelector(`.video-item[data-video-index="${videoIndex}"]`);
            if (item) {
                item.classList.add('completed');
                // XP ãƒãƒƒã‚¸ã‚’è¿½åŠ 
                const badge = item.querySelector('.xp-badge');
                if (!badge) {
                    const titleDiv = item.querySelector('div:first-child');
                    titleDiv.innerHTML += '<span class="xp-badge">+50 XP</span>';
                }
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const statusDiv = item.querySelector('div:last-child');
                if (statusDiv) {
                    statusDiv.textContent = 'å®Œäº†';
                }
            }
        }
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[INIT] Initializing player...');
            console.log('[INIT] Loading playlist videos...');
            loadPlaylistVideos();
            
            // YouTube ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’å®šæœŸçš„ã«ç›£è¦–
            // videoseries ã®å ´åˆã¯ã€API ã‹ã‚‰ç›´æ¥çŠ¶æ…‹å–å¾—ãŒå›°é›£ãªãŸã‚
            // ãƒãƒ¼ãƒªãƒ³ã‚°+postMessage ã‚’ä½¿ç”¨ã™ã‚‹
            setInterval(() => {
                if (playerReady && player) {
                    try {
                        // ç¾åœ¨ã®å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ï¼ˆpostMessage çµŒç”±ï¼‰
                        const iframe = document.getElementById('youtube-player');
                        if (iframe) {
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
                            recordPlaybackTime();
                        }
                    } catch (e) {
                        console.log('[MONITORING] Polling skipped:', e.message);
                    }
                }
            }, 3000);  // 3ç§’ã”ã¨
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‰ã˜ã‚‹éš›ã«å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ï¼ˆå®Ÿéš›ã®å®Œäº†æ™‚åˆ»ã‚’è¨ˆç®—ï¼‰
        window.addEventListener('beforeunload', () => {
            if (player && player.getCurrentTime) {
                const currentTime = Math.floor(player.getCurrentTime());
                if (currentTime > 0) {
                    // è¦–è´çµ‚äº†æ™‚ã¯å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
                    // ãŸã ã—navigateawayãªã®ã§ãƒ“ãƒ¼ã‚³ãƒ³ã‚’ä½¿ç”¨
                    navigator.sendBeacon('/api/video_view_event', JSON.stringify({
                        playlist_id: PLAYLIST_ID,
                        video_index: currentVideoIndex,
                        event_type: 'watch',
                        current_time: currentTime
                    }));
                }
            }
        });
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼šå³çŸ¢å°ã§ã‚¹ã‚­ãƒƒãƒ—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' && currentVideoIndex < ACTUAL_VIDEO_COUNT - 1) {
                switchToVideo(currentVideoIndex + 1);
            } else if (e.key === 'ArrowLeft' && currentVideoIndex > 0) {
                switchToVideo(currentVideoIndex - 1);
            }
        });
    </script>
</body>
</html>
