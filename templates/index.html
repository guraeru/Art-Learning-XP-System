{% extends "base.html" %}
{% block title %}ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
    <h2>{{ status.username }} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
    <div class="card status-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="status-item">
            <h4>ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</h4>
            <div class="xp-display">R{{ status.rank }}</div>
            <div class="rank-title">{{ status.title }}</div>
        </div>
        <div class="status-item">
            <h4>ç´¯è¨ˆXP</h4>
            <div class="xp-display">{{ "{:,.0f}".format(status.total_xp) }} XP</div>
        </div>
        <div class="status-item">
            <h4>æ¬¡ãƒ©ãƒ³ã‚¯ (R{{ status.rank + 1 }}) ã¾ã§</h4>
            <div class="xp-display">{{ "{:,.0f}".format(status.xp_to_next_rank) }} XP</div>
                {% set total_needed = status.next_xp_goal - status.xp_start_of_current_level %}
                {% set current_progress = status.total_xp - status.xp_start_of_current_level %}
                {% set percent = (current_progress / total_needed) * 100 if total_needed > 0 else 100 %}
                <div style="background-color: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                <div style="--progress-width: {{ percent | round(1) }}%; background-color: var(--accent-color); height: 100%; width: var(--progress-width);">
                </div>
            </div>
            <div class="rank-title">ï¼ˆç›®æ¨™: {{ "{:,.0f}".format(status.next_xp_goal) }} XPï¼‰</div>
        </div>
        <div class="status-item">
            <h4>ç´¯è¨ˆå­¦ç¿’æ™‚é–“</h4>
            <div class="xp-display">{{ status.total_time_hours }} æ™‚é–“</div>
            <div class="rank-title">{{ status.total_time_minutes % 60 }} åˆ†</div>
        </div>
    </div>

    <div class="grid-2" style="gap: 30px; margin-top: 30px;">
        
        <div class="card">
            <h3>æ™‚é–“å­¦ç¿’ã®è¨˜éŒ²</h3>
            
            <div id="timer-box" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; text-align: center;">
                <h4>ã‚¿ã‚¤ãƒ ã‚¦ã‚©ãƒƒãƒ (ãƒ–ãƒ©ã‚¦ã‚¶æ°¸ç¶šåŒ–)</h4>
                <div id="timer-display" style="font-size: 2.5em; font-weight: bold; color: var(--accent-color); margin: 10px 0;">00:00:00</div>
                <div class="stack-sm" style="justify-content: space-around;">
                    <button type="button" id="start-btn" class="btn-primary full-width">é–‹å§‹</button>
                    <button type="button" id="stop-btn" class="btn-secondary full-width" disabled>åœæ­¢ï¼†è¨˜éŒ²</button>
                    <button type="button" id="reset-btn" class="btn-secondary full-width" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            <form action="{{ url_for('log_time') }}" method="POST" id="log-time-form">
                <div class="form-group">
                    <label for="activity_type">æ´»å‹•ã‚¿ã‚¤ãƒ—:</label>
                    <select name="activity_type" id="activity_type" class="form-control">
                        {% for type, rate in xp_rates.items() %}
                            <option value="{{ type }}">{{ type }} ({{ rate }} XP/åˆ†)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="duration">æ™‚é–“ (åˆ†):</label>
                    <input type="number" name="duration" id="duration" class="form-control" required min="1" value="60">
                </div>
                <div class="form-group">
                    <label for="time_description">å†…å®¹ãƒ¡ãƒ¢:</label>
                    <input type="text" name="description" id="time_description" class="form-control" placeholder="ä¾‹: é¡”ã®ãƒ‘ãƒ¼ãƒ„ç·´ç¿’ã€è‰²èª¿è£œæ­£ã®å‹‰å¼·">
                </div>
                <button type="submit" id="log-time-submit-btn" class="btn-primary" style="width: 100%;">æ‰‹å‹•ã§è¨˜éŒ² (ï¼‹XP)</button>
            </form>
        </div>
        <div class="card">
            <h3>ç§‘ç›®ç¿’å¾—ã®è¨˜éŒ² (ä½œå“ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)</h3>
            <form action="{{ url_for('log_acquisition') }}" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="technique_type">æŠ€æ³•ã‚¿ã‚¤ãƒ—:</label>
                    <select name="technique_type" id="technique_type" class="form-control">
                        {% for type, base_xp in acq_types.items() %}
                            <option value="{{ type }}">{{ type }} (ãƒ™ãƒ¼ã‚¹XP: {{ "{:,.0f}".format(base_xp) }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="evaluation">è‡ªå·±è©•ä¾¡:</label>
                        <select name="evaluation" id="evaluation" class="form-control" required>
                            {% for eval, score in evaluations.items()|sort(attribute='1', reverse=True) %}
                                <option value="{{ eval }}">{{ eval }} (ã‚¹ã‚³ã‚¢: {{ score }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 3;">
                        <label for="image_proof">è¨¼æ‹ ç”»åƒ (PNG, JPG, GIF):</label>
                        <input type="file" name="image_proof" id="image_proof" class="form-control" required accept="image/*">
                    </div>
                </div>
                <div class="form-group">
                    <label for="acq_description">ä½œå“/æŠ€æ³•ã®è©³ç´°:</label>
                    <input type="text" name="description" id="acq_description" class="form-control" placeholder="ä¾‹: é è¿‘æ³•ã®ãƒ‘ãƒ¼ã‚¹ç·´ç¿’ã€æ–°ãƒ„ãƒ¼ãƒ«ã®ç¿’å¾—">
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">ç§‘ç›®ç¿’å¾—ã‚’è¨˜éŒ² (ï¼‹XP)</button>
            </form>
        </div>
    </div>
    
    <div class="card" style="margin-top: 30px;">
        <h3>ğŸ”— ãŠã™ã™ã‚å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹ (å¤–éƒ¨ãƒªãƒ³ã‚¯)</h3>
        
        {% if recent_links %}
            <ul class="resource-list" style="list-style: none; padding: 0;">
                {% for link in recent_links %}
                    <li style="margin-bottom: 10px; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px;">
                        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" style="font-weight: bold; color: var(--accent-color);">
                             {{ link.name }}
                        </a>
                        <p style="margin: 5px 0 0; font-size: 0.9em; color: #666;">{{ link.description }}</p>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>ç¾åœ¨ã€ãŠã™ã™ã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const display = document.getElementById('timer-display');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const resetBtn = document.getElementById('reset-btn');
            const logTimeForm = document.getElementById('log-time-form');
            const durationInput = document.getElementById('duration');
            const descriptionInput = document.getElementById('time_description');
            const logTimeSubmitBtn = document.getElementById('log-time-submit-btn');

            // --- LocalStorage ã‚­ãƒ¼ ---
            const LS_RUNNING = 'timerIsRunning';
            const LS_START_TIME = 'timerStartTime';
            
            // --- çŠ¶æ…‹å¤‰æ•° ---
            let timerInterval = null;
            let isRunning = localStorage.getItem(LS_RUNNING) === 'true';
            let startTime = parseInt(localStorage.getItem(LS_START_TIME) || '0');
            
            // ----------------------------------------------------
            
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            function toggleTimeForm(disabled) {
                durationInput.disabled = disabled;
                descriptionInput.disabled = disabled;
                logTimeSubmitBtn.disabled = disabled;
                
                if (disabled) {
                    logTimeSubmitBtn.textContent = 'ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ (æ‰‹å‹•è¨˜éŒ²ä¸å¯)';
                    logTimeSubmitBtn.classList.remove('btn-primary');
                    logTimeSubmitBtn.classList.add('btn-secondary');
                } else {
                    logTimeSubmitBtn.textContent = 'æ‰‹å‹•ã§è¨˜éŒ² (ï¼‹XP)';
                    logTimeSubmitBtn.classList.remove('btn-secondary');
                    logTimeSubmitBtn.classList.add('btn-primary');
                }
            }
            
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: çµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ã‚’è¨ˆç®—
            function getElapsedTime() {
                if (isRunning && startTime > 0) {
                    return Date.now() - startTime;
                }
                return 0; 
            }

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
            function updateDisplay() {
                const elapsedMs = getElapsedTime();
                const totalSeconds = Math.floor(elapsedMs / 1000);
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                display.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: UIã®çŠ¶æ…‹ã‚’LocalStorageã®çŠ¶æ…‹ã«åŒæœŸã•ã›ã‚‹
            function syncUI() {
                toggleTimeForm(isRunning);
                startBtn.disabled = isRunning;
                stopBtn.disabled = !isRunning;
                resetBtn.disabled = !isRunning;
                
                if (isRunning) {
                    // ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ä½œã—ã¦ã„ã‚Œã°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’é–‹å§‹
                    if (!timerInterval) {
                        timerInterval = setInterval(updateDisplay, 1000);
                    }
                } else {
                    // åœæ­¢ã—ã¦ã„ã‚Œã°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    // åœæ­¢æ™‚ã¯è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (startTime === 0) {
                        display.textContent = "00:00:00";
                    }
                }
                updateDisplay(); // å³åº§ã«æ›´æ–°
            }
            // ----------------------------------------------------

            // é–‹å§‹ãƒœã‚¿ãƒ³ã®å‡¦ç†: LocalStorageã«é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
            startBtn.addEventListener('click', function() {
                if (isRunning) return; 

                isRunning = true;
                startTime = Date.now();
                
                // LocalStorageã«çŠ¶æ…‹ã‚’ä¿å­˜
                localStorage.setItem(LS_RUNNING, 'true');
                localStorage.setItem(LS_START_TIME, startTime);
                
                syncUI();
                // é–‹å§‹æ™‚ã®alertã¯éè¡¨ç¤º
            });

            // åœæ­¢ï¼†è¨˜éŒ²ãƒœã‚¿ãƒ³ã®å‡¦ç†: çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            stopBtn.addEventListener('click', function() {
                if (!isRunning) return;

                const elapsedMs = getElapsedTime();
                
                // çµŒéæ™‚é–“ (åˆ†æ•°) ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ (æœ€å°1åˆ†ã‚’ä¿è¨¼)
                const totalMinutes = Math.max(1, Math.round(elapsedMs / 1000 / 60)); 

                // ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
                durationInput.value = totalMinutes;
                descriptionInput.value = descriptionInput.value || `ã‚¿ã‚¤ãƒ ã‚¦ã‚©ãƒƒãƒã§è¨˜éŒ²: ${totalMinutes} åˆ†é–“ã®å­¦ç¿’`;
                
                // LocalStorageã¨çŠ¶æ…‹å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isRunning = false;
                startTime = 0;
                localStorage.removeItem(LS_RUNNING);
                localStorage.removeItem(LS_START_TIME);
                
                syncUI();
                
                // è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•é€ä¿¡
                logTimeForm.submit();
                // åœæ­¢æ™‚ã¯å®Œäº†é€šçŸ¥
                alert(`âœ… ã‚¿ã‚¤ãƒ ã‚¦ã‚©ãƒƒãƒã‚’åœæ­¢ã—ã€${totalMinutes} åˆ†ã®å­¦ç¿’ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`); 
            });

            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†: LocalStorageã¨çŠ¶æ…‹å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetBtn.addEventListener('click', function() {
                // ãƒªã‚»ãƒƒãƒˆæ™‚ã®confirmã¯ç¶­æŒ
                if (!confirm('âš ï¸ æœ¬å½“ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿè¨ˆæ¸¬ä¸­ã®æ™‚é–“ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                    return;
                }
                
                // LocalStorageã¨çŠ¶æ…‹å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isRunning = false;
                startTime = 0;
                localStorage.removeItem(LS_RUNNING);
                localStorage.removeItem(LS_START_TIME);

                syncUI();
                
                // æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                durationInput.value = 60;
                descriptionInput.value = '';
            });
            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
            syncUI();
        });
    </script>
{% endblock %}