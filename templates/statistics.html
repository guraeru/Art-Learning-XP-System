{% extends "base.html" %}
{% block title %}çµ±è¨ˆãƒ»åˆ†æ{% endblock %}

{% block content %}
    <h2>ğŸ“Š çµ±è¨ˆãƒ»åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>

    <div class="card" style="margin-bottom: 20px;">
        <h3>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/api/export/csv" class="btn-primary" download>CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>
            <a href="/api/export/json" class="btn-primary" download>JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>
        </div>
    </div>

    <div class="tabs" style="margin-bottom: 20px;">
        <button class="tab-button btn-primary" data-tab="xp-analysis">XPåˆ†æ</button>
        <button class="tab-button" data-tab="learning-patterns">å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
        <button class="tab-button" data-tab="youtube-stats">YouTubeé€²æ—</button>
        <button class="tab-button" data-tab="work-stats">ä½œå“çµ±è¨ˆ</button>
    </div>

    <!-- XPåˆ†æã‚¿ãƒ– -->
    <div id="xp-analysis" class="tab-content card">
        <h3>XPç²å¾—åˆ†æ</h3>
        
        <div style="margin-bottom: 30px;">
            <h4>æŠ€æ³•åˆ¥XPç²å¾—é‡ï¼ˆæ™‚é–“å­¦ç¿’ï¼‰</h4>
            <canvas id="xpByTechniqueTimeChart" style="max-height: 300px;"></canvas>
        </div>

        <div style="margin-bottom: 30px;">
            <h4>æŠ€æ³•åˆ¥XPç²å¾—é‡ï¼ˆä½œå“åˆ¶ä½œï¼‰</h4>
            <canvas id="xpByTechniqueAcqChart" style="max-height: 300px;"></canvas>
        </div>

        <div style="margin-bottom: 30px;">
            <h4>è©•ä¾¡åˆ¥ä½œå“æ•°</h4>
            <canvas id="evaluationCountChart" style="max-height: 300px;"></canvas>
        </div>

        <div style="margin-bottom: 30px;">
            <h4>è©•ä¾¡åˆ¥XPç²å¾—é‡</h4>
            <canvas id="evaluationXpChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¿ãƒ– -->
    <div id="learning-patterns" class="tab-content card" style="display: none;">
        <h3>å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</h3>
        
        <div style="margin-bottom: 30px;">
            <h4>æ›œæ—¥åˆ¥å­¦ç¿’æ™‚é–“</h4>
            <canvas id="weekdayChart" style="max-height: 300px;"></canvas>
        </div>

        <div style="margin-bottom: 30px;">
            <h4>æ™‚é–“å¸¯åˆ¥å­¦ç¿’æ™‚é–“</h4>
            <canvas id="timePeriodChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- YouTubeé€²æ—ã‚¿ãƒ– -->
    <div id="youtube-stats" class="tab-content card" style="display: none;">
        <h3>YouTubeãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé€²æ—</h3>
        <div id="youtube-progress-container">
            <p style="text-align: center; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <!-- ä½œå“çµ±è¨ˆã‚¿ãƒ– -->
    <div id="work-stats" class="tab-content card" style="display: none;">
        <h3>ä½œå“åˆ¶ä½œçµ±è¨ˆ</h3>
        <p style="color: #666; margin-bottom: 20px;">ä½œå“åˆ¶ä½œã«é–¢ã™ã‚‹è©³ç´°ãªçµ±è¨ˆæƒ…å ±</p>
        
        <div style="margin-bottom: 30px;">
            <h4>æŠ€æ³•åˆ¥ä½œå“æ•°</h4>
            <canvas id="worksByTechniqueChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.tab;

                    // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    tabs.forEach(t => {
                        t.classList.remove('btn-primary');
                        t.style.backgroundColor = '#ddd';
                        t.style.color = 'var(--text-color)';
                    });
                    tab.classList.add('btn-primary');
                    tab.style.backgroundColor = 'var(--accent-color)';
                    tab.style.color = 'white';

                    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤º
                    contents.forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(targetId).style.display = 'block';
                });
            });

            // åˆæœŸè¡¨ç¤º
            const initialTab = document.querySelector('.tab-button[data-tab="xp-analysis"]');
            if (initialTab) {
                initialTab.click();
            }

            // ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
            loadXpStatistics();
            loadLearningPatterns();
            loadYoutubeProgress();
            loadWorkStatistics();
        });

        // XPçµ±è¨ˆã®èª­ã¿è¾¼ã¿
        function loadXpStatistics() {
            // æŠ€æ³•åˆ¥XPçµ±è¨ˆ
            fetch('/api/statistics/xp_by_technique')
                .then(response => response.json())
                .then(data => {
                    // æ™‚é–“å­¦ç¿’ã‚°ãƒ©ãƒ•
                    if (data.time_learning.labels.length > 0) {
                        const ctx1 = document.getElementById('xpByTechniqueTimeChart').getContext('2d');
                        new Chart(ctx1, {
                            type: 'bar',
                            data: {
                                labels: data.time_learning.labels,
                                datasets: [{
                                    label: 'ç²å¾—XP',
                                    data: data.time_learning.data,
                                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'XP'
                                        }
                                    }
                                }
                            }
                        });
                    }

                    // ä½œå“åˆ¶ä½œã‚°ãƒ©ãƒ•
                    if (data.acquisition.labels.length > 0) {
                        const ctx2 = document.getElementById('xpByTechniqueAcqChart').getContext('2d');
                        new Chart(ctx2, {
                            type: 'bar',
                            data: {
                                labels: data.acquisition.labels,
                                datasets: [{
                                    label: 'ç²å¾—XP',
                                    data: data.acquisition.data,
                                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'XP'
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => console.error('XPçµ±è¨ˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error));

            // è©•ä¾¡åˆ¥çµ±è¨ˆ
            fetch('/api/statistics/xp_by_evaluation')
                .then(response => response.json())
                .then(data => {
                    if (data.labels.length > 0) {
                        // ä½œå“æ•°ã‚°ãƒ©ãƒ•
                        const ctx3 = document.getElementById('evaluationCountChart').getContext('2d');
                        new Chart(ctx3, {
                            type: 'pie',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    data: data.counts,
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.8)',
                                        'rgba(54, 162, 235, 0.8)',
                                        'rgba(255, 206, 86, 0.8)',
                                        'rgba(75, 192, 192, 0.8)',
                                        'rgba(153, 102, 255, 0.8)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    }
                                }
                            }
                        });

                        // XPç²å¾—é‡ã‚°ãƒ©ãƒ•
                        const ctx4 = document.getElementById('evaluationXpChart').getContext('2d');
                        new Chart(ctx4, {
                            type: 'bar',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: 'ç²å¾—XP',
                                    data: data.total_xp,
                                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'XP'
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => console.error('è©•ä¾¡åˆ¥çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error));
        }

        // å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿
        function loadLearningPatterns() {
            fetch('/api/statistics/learning_patterns')
                .then(response => response.json())
                .then(data => {
                    // æ›œæ—¥åˆ¥ã‚°ãƒ©ãƒ•
                    const ctx5 = document.getElementById('weekdayChart').getContext('2d');
                    new Chart(ctx5, {
                        type: 'bar',
                        data: {
                            labels: data.weekday.labels,
                            datasets: [{
                                label: 'å­¦ç¿’æ™‚é–“ (æ™‚é–“)',
                                data: data.weekday.data,
                                backgroundColor: 'rgba(153, 102, 255, 0.8)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'æ™‚é–“'
                                    }
                                }
                            }
                        }
                    });

                    // æ™‚é–“å¸¯åˆ¥ã‚°ãƒ©ãƒ•
                    const ctx6 = document.getElementById('timePeriodChart').getContext('2d');
                    new Chart(ctx6, {
                        type: 'doughnut',
                        data: {
                            labels: data.time_period.labels,
                            datasets: [{
                                data: data.time_period.data,
                                backgroundColor: [
                                    'rgba(255, 206, 86, 0.8)',
                                    'rgba(54, 162, 235, 0.8)',
                                    'rgba(255, 99, 132, 0.8)',
                                    'rgba(75, 192, 192, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error));
        }

        // YouTubeé€²æ—ã®èª­ã¿è¾¼ã¿
        function loadYoutubeProgress() {
            fetch('/api/statistics/youtube_progress')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('youtube-progress-container');
                    
                    if (data.playlists.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">YouTubeãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                        return;
                    }

                    let html = '<div style="display: grid; gap: 15px;">';
                    data.playlists.forEach(playlist => {
                        html += `
                            <div class="card" style="padding: 15px;">
                                <h4 style="margin: 0 0 10px 0;">${playlist.title}</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <strong>ç·å‹•ç”»æ•°:</strong> ${playlist.total_videos}
                                    </div>
                                    <div>
                                        <strong>å®Œäº†æ•°:</strong> ${playlist.completed_videos}
                                    </div>
                                    <div>
                                        <strong>é€²æ—ç‡:</strong> ${playlist.progress_rate}%
                                    </div>
                                    <div>
                                        <strong>ç²å¾—XP:</strong> ${playlist.total_xp.toLocaleString()} XP
                                    </div>
                                </div>
                                <div style="background-color: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                                    <div style="width: ${playlist.progress_rate}%; background-color: var(--accent-color); height: 100%;"></div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    container.innerHTML = html;
                })
                .catch(error => console.error('YouTubeé€²æ—ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error));
        }

        // ä½œå“çµ±è¨ˆã®èª­ã¿è¾¼ã¿
        function loadWorkStatistics() {
            fetch('/api/statistics/xp_by_technique')
                .then(response => response.json())
                .then(data => {
                    if (data.acquisition.labels.length > 0) {
                        // æŠ€æ³•åˆ¥ä½œå“æ•°ã‚’è¨ˆç®—ï¼ˆXPã‹ã‚‰æ¨å®šï¼‰
                        const ctx7 = document.getElementById('worksByTechniqueChart').getContext('2d');
                        new Chart(ctx7, {
                            type: 'pie',
                            data: {
                                labels: data.acquisition.labels,
                                datasets: [{
                                    data: data.acquisition.data,
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.8)',
                                        'rgba(54, 162, 235, 0.8)',
                                        'rgba(255, 206, 86, 0.8)',
                                        'rgba(75, 192, 192, 0.8)',
                                        'rgba(153, 102, 255, 0.8)',
                                        'rgba(255, 159, 64, 0.8)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    },
                                    title: {
                                        display: true,
                                        text: 'æŠ€æ³•åˆ¥XPåˆ†å¸ƒ'
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => console.error('ä½œå“çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error));
        }
    </script>

    <style>
        .tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .tab-button {
            background-color: #ddd;
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            white-space: nowrap;
        }
        .tab-button:not(.btn-primary):hover {
            background-color: #ccc;
        }
    </style>
{% endblock %}

